import{h as ie,e as d,n as O,k as ne,i as G,j as p,b as $,F as X,t as H,y as M,z as re,C as K,r as ae,o as Y}from"./web-DuEVvOp5.js";import{l as Z}from"./UKTBL2JL-CnBKWN1M.js";import{C as le,B as ce}from"./BoardView-BhTIAIwV.js";import{u as he,E as de,a as me,b as fe}from"./RepertoireCard-DZ_THEJ2.js";import{s as ee,L as ge,t as ve,m as ue,u as te}from"./Context-D0aeQrfF.js";import{C as V}from"./chess-lriRiorr.js";import"./index-HbBCBvHV.js";class pe{state;api=null;starting_position;history;ai;cache;constructor(){this.state=new V,this.starting_position=ee(),this.ai={white:!1,black:!0},this.history={index:0,moves:[]}}listeners=[];once_listeners=[];attach(e){this.api=le(e,{}),this.cache=new ge("computer-move"),this.cache.load();const t=this;this.api.set({movable:{events:{after(o,f){t.handle_move(`${o}${f}`)}}}}),this.update_board(),addEventListener("keydown",o=>{o.key==="ArrowLeft"&&this.undoMove(),o.key==="ArrowRight"&&(console.log("REDO"),this.redoMove())})}setStartingPosition(e){this.state.loadPgn(e),this.starting_position=this.state.fen(),this.update_board()}undoMove(){const e=this.history.moves.slice(0,Math.max(this.history.index-1,0));this.state.reset();for(const t of e)this.state.move(t);this.history.index=Math.max(0,this.history.index-1),this.update_board()}redoMove(){const e=this.history.moves.slice(0,this.history.index+1);this.state.reset();for(const t of e)this.state.move(t);this.history.index=Math.min(this.history.moves.length,this.history.index+1),this.update_board()}restart(){this.state.reset(),this.state.load(this.starting_position),this.history.index=0,this.history.moves=[],this.update_board(),this.api?.set({lastMove:void 0})}subscribe(e){this.listeners.push(e)}get_next(e){this.once_listeners.push(e)}emit(){const e=this.state.fen(),t=this.history.moves;for(const o of this.listeners)o({fen:e,history:t});for(const o of this.once_listeners)o({fen:e,history:t});this.once_listeners=[]}handle_move(e){this.state.move(e),this.history.moves=this.state.history(),this.history.index=this.history.moves.length,this.update_board(),this.ai[this.turncolor()]}async play_common_move(){const e="https://explorer.lichess.ovh/lichess?variant=standard&speeds=blitz&ratings=2000,2400&fen="+encodeURIComponent(this.state.fen()),t=this.state.fen();let o;try{o=await this.cache?.get(t)}catch{return}const f=w=>{let r=w.moves;if(r.length>0){if(r[0].white+r[0].black+r[0].draws<100){this.restart();return}let k=be(r),a=ue(k.uci);this.play_move(a)}};o===void 0?fetch(e).then(w=>{const r=this.cache;console.log("FETCHING..."),w.json().then(async g=>{const k=await r?.count();g.moves&&(await r?.add(this.state.fen(),g),console.log(k),console.log(g),f(g))})}):(console.log("CACHED------------"),console.log(o),o.moves||this.cache?.remove(t),f(o))}play_move(e){this.state.move(e),this.history.moves=this.state.history(),this.history.index=this.history.moves.length,this.update_board()}turncolor(){return this.state.fen()==="w"?"white":"black"}update_board(){const e=this.state.turn()==="w"?"white":"black";this.api?.set({fen:this.state.fen(),turnColor:e,movable:{color:e,free:!1,dests:ve(this.state)}}),this.emit()}}function be(m){let e=m.map(f=>f.black+f.draws+f.white),t;for(t=1;t<e.length;t++)e[t]+=e[t-1];var o=Math.random()*e[e.length-1];for(t=0;t<e.length&&!(e[t]>o);t++);return m[t]}var _e=H('<div><div class="px-3 py-2 flex items-center"><div></div><div class=""><!$><!/>%</div></div><div>'),ye=H('<div class="font-medium h-[20px] leading-[20px]">â€¢ <!$><!/>'),xe=H('<div class="flex flex-col shrink grow min-h-0 w-[20vw] overflow-visible"><div class="flex flex-col shrink min-h-0 overflow-visible overflow-y-scroll px-4">');const $e=m=>{te();const[e,t]=d([]),o=new Map,[f,w]=d(new Map),[r,g]=d([]),[k,a]=d(1);d(50),O(async()=>{await b(m.pgn)});const b=async _=>{console.log("new history"),console.log(m.pgn);const h=m.pgn.join(""),y=o.get(h);if(y){const l=[],s=y.name.split(":");if(l.push(s[0].trim()),s.length>1)for(const x of s[1].split(","))l.push(x.trim());t(l)}else t([]);const i=new V;for(const l of m.pgn)i.move(l);const n=i.fen(),v=f().get(n);if(v){a(v.games);const s=[...Object.entries(v.openings)];s.sort((E,j)=>j[1].count-E[1].count);let x=0;for(const E of s)x+=E[1].count;g(s)}else g([])};ne(async()=>{const h=await(await fetch("/rust_tree.json")).json(),i=await(await fetch("/openings.json")).json();for(const n of i.openings){let v=n.pgn.split(" "),l=[];for(let s=0;s<v.length;s++)s%3!==0&&l.push(v[s]);o.set(l.join(""),n)}w(new Map(Object.entries(h))),await b(m.pgn)});const R=(_,h,y,i,n,v,l)=>{let s=[];h.variations&&(s=[...Object.entries(h.variations)]);let[x,E]=d(!1),[j,T]=d(!1),[S,B]=d(!1);O(()=>{let u=i==l-1,L=i===0;n()!=null&&(u=u||i==n()-1,L=L||i==n()+1),T(u),E(L),B(i===n()||l===1)});let F=s.slice(0,5).length;return(()=>{var u=G(_e),L=u.firstChild,q=L.firstChild,W=q.nextSibling,se=W.firstChild,[J,oe]=M(se.nextSibling);J.nextSibling;var P=L.nextSibling;return u.$$click=()=>{v(c=>i===c?null:i)},u.addEventListener("mouseleave",()=>!1),u.addEventListener("mouseenter",()=>!0),p(q,_),p(W,()=>Math.round(h.count*100/y),J,oe),p(P,$(X,{get each(){return s.slice(0,5)},children:([c,A],D)=>I(c,A,D()===s.length-1)})),re(c=>{var A=`mono hover:cursor-pointer dark:hover:bg-accent-700 text-accent-700 dark:text-accent-200 hover:bg-accent-200 sk-position-item ${x()?"rounded-t-lg border-t":""} ${j()?"rounded-b-lg border-b":""} border-b border-x   ${S()?"dark:bg-accent-800 bg-accent-200 rounded-lg my-4 border dark:border-accent-700 border-accent-300":"dark:bg-accent-900 bg-accent-100 my-0 dark:border-accent-800  border-accent-200"} ${S()&&i==0?"mt-0":""}`,D=`text-md ${S()?"text-lg font-semibold dark:text-accent-300":"font-normal"} grow`,U=S()&&F>0?`calc(${F*20}px + ${(F-1)*.25}rem + 1rem)`:"0px",z=S()&&s.length>0?"0.5rem 0.5rem":"0rem 0.5rem",Q=`sk-position-child rounded-b-lg flex flex-col gap-1 overflow-hidden bg-accent-100 dark:bg-accent-700 dark:text-accent-300 ${S(),""}`;return A!==c.e&&K(u,c.e=A),D!==c.t&&K(q,c.t=D),U!==c.a&&((c.a=U)!=null?P.style.setProperty("height",U):P.style.removeProperty("height")),z!==c.o&&((c.o=z)!=null?P.style.setProperty("padding",z):P.style.removeProperty("padding")),Q!==c.i&&K(P,c.i=Q),c},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0}),ae(),u})()},I=(_,h,y,i)=>(()=>{var n=G(ye),v=n.firstChild,l=v.nextSibling,[s,x]=M(l.nextSibling);return p(n,_,s,x),n})(),[N,C]=d(null);return O(()=>{console.log(N())}),(()=>{var _=G(xe),h=_.firstChild;return p(h,$(X,{get each(){return r()},children:([y,i],n)=>R(y,i,k(),n(),N,C,r().length)})),_})()};ie(["click","mouseover"]);var we=H('<div class="flex min-h-0 shrink justify-center pb-4 px-4 dark:bg-accent-950 bg-accent-50"><div class="flex sk-fit shrink overflow-visible"></div><!$><!/><div class="flex flex-col gap-4 w-[500px] h-[100%] min-h-0 shrink px-4"><!$><!/><!$><!/><!$><!/><!$><!/><!$><!/>');const Pe=()=>{const m=te(),e=new pe,[t,o]=d(ee()),[f,w]=d([]);d([]);const[r,g]=d(!1);e.subscribe(({fen:a,history:b})=>{o(a),w([...b]),m.engine.enqueue_main(a)});const k=he();return O(Y(k,()=>{const a=k();a&&a.key==="Escape"&&g(!1)})),O(Y(r,()=>{r()&&e.get_next(a=>{if(r()){let b=new V;for(let R of a.history.slice(0,-1))b.move(R);m.repertoire.addLine(b.fen(),a.history.at(-1)),g(!1)}})})),(()=>{var a=G(we),b=a.firstChild,R=b.nextSibling,[I,N]=M(R.nextSibling),C=I.nextSibling,_=C.firstChild,[h,y]=M(_.nextSibling),i=h.nextSibling,[n,v]=M(i.nextSibling),l=n.nextSibling,[s,x]=M(l.nextSibling),E=s.nextSibling,[j,T]=M(E.nextSibling),S=j.nextSibling,[B,F]=M(S.nextSibling);return p(b,$($e,{get pgn(){return f()},on_select:u=>e.handle_move(u)})),p(a,$(ce,{get class(){return`${r()?"border-4 border-red-500 -ml-2 -mt-0.5":""}`},game:e,rounded:!0}),I,N),p(C,$(de,{}),h,y),p(C,$(me,{get fen(){return t()},requestLine:()=>g(!0)}),n,v),p(C,$(fe,{get fen(){return t()},playerColor:"white"}),s,x),p(C,$(Z,{class:"button",onClick:()=>e.restart(),children:"Restart"}),j,T),p(C,$(Z,{class:"button",onClick:()=>e.play_common_move(),children:"Play"}),B,F),a})()};export{Pe as default};
