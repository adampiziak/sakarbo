import{createComponent as dr}from"solid-js/web";import{onMount as fr,createContext as mr,useContext as br}from"solid-js";import{parse as gr}from"@mliebelt/pgn-parser";import{Chess as U,SQUARES as wr}from"chess.js";import{createEmptyCard as pr}from"ts-fsrs";class Ot{username=null;load(){this.username=localStorage.getItem("username")}get(){return this.username}set(t){this.username=t,localStorage.setItem("username",this.username)}}class yr{db=null;username="";lastChange={white:new Date,black:new Date};lastFetch={white:new Date(0),black:new Date(0)};cache={white:[],black:[]};whiteGames=[];blackGames=[];ready=!1;load_wait(){return new Promise((t,n)=>{this.ready&&t();const o=new Ot;o.load();const c=o.get();if(c)this.username=c;else{n();return}const h=window.indexedDB.open(`player-graph-${this.username}`,2);h.onerror=d=>{console.error("DB ERROR")},h.onsuccess=d=>{this.db||(this.db=d.target?.result),this.db?t():n()},h.onupgradeneeded=d=>{console.log("UPGRADE NEEDED");const g=d.target.result;g.createObjectStore("whitewhite",{keyPath:"fen"}),g.createObjectStore("whiteblack",{keyPath:"fen"}),g.createObjectStore("blackblack",{keyPath:"fen"}),g.createObjectStore("blackwhite",{keyPath:"fen"})}})}load(t){this.username=t;const n=window.indexedDB.open(`player-graph-${t}`,2);n.onerror=o=>{console.error("DB ERROR")},n.onsuccess=o=>{this.db||(this.db=o.target?.result)},n.onupgradeneeded=o=>{console.log("UPGRADE NEEDED");const c=o.target.result;c.createObjectStore("whitewhite",{keyPath:"fen"}),c.createObjectStore("whiteblack",{keyPath:"fen"}),c.createObjectStore("blackblack",{keyPath:"fen"}),c.createObjectStore("blackwhite",{keyPath:"fen"})}}async getPosition(t,n,o){return new Promise((c,h)=>{const d=n+o,g=this.db?.transaction(d,"readonly").objectStore(d);if(g){let l=g.get(t);l.onsuccess=E=>{if(!l.result?.moves){console.log("NOT FOUND"),c(void 0);return}c(l.result)},l.onerror=E=>{c(void 0)}}else h("object store is null")})}async getFen(t,n,o){return new Promise((c,h)=>{const d=n+o,g=this.db?.transaction(d,"readonly").objectStore(d);if(g){let l=g.get(t);l.onsuccess=E=>{const D=l.result?.moves;if(!D){console.log("NOT FOUND"),c([]);return}const R=Object.entries(D).toSorted((N,P)=>P[1].count-N[1].count);c(R)},l.onerror=E=>{c("error")}}else h("object store is null")})}isready(){return this.db!==void 0&&this.db!==null}async getAll(){const t=await this.getMostCommonPositions("white"),n=await this.getMostCommonPositions("black");return[...t,...n]}async getBlackWhite(){return new Promise((t,n)=>{const c=this.db?.transaction("blackwhite","readonly").objectStore("blackwhite")?.getAll();c.onsuccess=h=>{t(c?.result)}})}async getAllSplit(){let t=["whitewhite","whiteblack","blackblack","blackwhite"],n={whitewhite:new Map,whiteblack:new Map,blackblack:new Map,blackwhite:new Map};for(const o of t){let h=(await this.getCombo(o)).reduce((d,g)=>(d.set(g.fen,g),d),new Map);n[o]=h}return n}async getCombo(t){return new Promise((n,o)=>{const c=this.db?.transaction(t,"readonly").objectStore(t);if(c){let h=c?.getAll();h.onsuccess=d=>{n(h.result)}}})}async getMostCommonPositions(t){return t=t+t,new Promise(n=>{if(this.lastFetch[t]>this.lastChange[t])console.log("cached"),n(this.cache[t]);else{console.log("loading..."),this.db||console.log("NOT READY");const o=this.db?.transaction(t,"readonly").objectStore(t);if(o){let c=o.getAll();c.onsuccess=h=>{this.lastFetch[t]=new Date;let d=c.result;this.cache[t]=d,n(this.cache[t])}}}})}async graph(){console.log("hi")}async refresh(){if(!this.username)return;const t=new Date,n=localStorage.getItem("last_refresh"),o=n?new Date(n):new Date(0),c=o.getTime();if((t-o)/1e3/60<10)return;localStorage.setItem("last_refresh",new Date().toString());const g=`https://lichess.org/api/games/user/${this.username}?since=${c}&max=700&perfType=blitz?rated=true`;try{const E=(await fetch(g)).body?.getReader();let D=!1,R=!0;for(;!D;){const N=await E?.read();if(!N)break;const{value:P,done:S}=N;if(D=S,S)break;const w=new TextDecoder().decode(P),I=gr(w,{startRule:"games"});R&&(localStorage.setItem("lastgame",JSON.stringify(I[0])),R=!1),await this.parseGames(I)}console.log("done")}catch(l){console.error(l)}}addMoveAsColor(t,n,o,c,h,d){return new Promise((g,l)=>{if(t==="rnbqkbnr/pppppp1p/6p1/8/2P5/8/PP1PPPPP/RNBQKBNR w KQkq - 0 2"&&(console.log("xxxxxxxxxxx"),console.log(d),console.log(h)),this.db){const E=`${o}${c}`,R=this.db.transaction(E,"readwrite").objectStore(E),N=R.get(t);N.onsuccess=P=>{let S=N.result??{fen:t,count:0,moves:{},result:{white:0,black:0,draw:0}};S.result.white+=h.white,S.result.black+=h.black,S.result.draw+=h.draw,S.count+=1,S.moves[n]||(S.moves[n]={uci:n,count:0,result:{white:0,black:0,draw:0}}),S.moves[n].count+=1,S.moves[n].result.white+=h.white,S.moves[n].result.black+=h.black,S.moves[n].result.draw+=h.draw;const w=R.put(S);w.onsuccess=I=>{g()},w.onerror=I=>{console.error(I),l()}},N.onerror=P=>{console.error("ERROR"),l()}}})}async parseGames(t){for(const n of t){const o=n.tags.White.toLowerCase()==this.username.toLowerCase()?"white":"black";if(n.tags?.Variant!="Standard")continue;const c=n.tags?.Result,h=n.tags?.Site,d={white:0,black:0,draw:0};switch(c?.split("-")[0]){case"1":d.white=1;break;case"0":d.black=1;break;case"1/2":d.draw=1;break}const g=new U;console.log("------");for(const l of n.moves){const E=l.notation.notation,D=g.turn()=="w"?"white":"black",R=g.fen();g.move(E),await this.addMoveAsColor(R,E,o,D,d,h)}}}}class vr{db=null;constructor(){}ready(){return this.db!==null&&this.db!==void 0}load(){return new Promise((t,n)=>{this.db&&t();const o=window.indexedDB.open("repertoire",2);o.onerror=c=>{console.error("DB ERROR")},o.onsuccess=c=>{this.db||(this.db=c.target?.result),t()},o.onupgradeneeded=c=>{console.log("UPGRADE NEEDED"),c.target.result.createObjectStore("position",{keyPath:"fen"})}})}load_json(t){for(const n of t){const c=this.db.transaction("position","readwrite").objectStore("position"),h={card:{due:new Date(n.card.due),last_review:new Date(n.card.last_review),...n.card},...n};console.log(h),c.put(h)}}addLine(t,n){if(console.log("adding response to LINE"),this.db){console.log(this.db);const c=this.db.transaction("position","readwrite").objectStore("position"),h=pr();c.put({fen:t,response:[n],card:h})}}updateRep(t,n){this.db&&this.db.transaction("position","readwrite").objectStore("position").put({fen:t.fen,response:t.response,card:n})}getAll(){if(this.db){const o=this.db.transaction("position","readonly").objectStore("position").getAll();return new Promise((c,h)=>{o.onsuccess=d=>{c(o.result)},o.onerror=d=>{h()}})}else return console.error("ERROR"),new Promise((t,n)=>{n()})}getLine(t){return new Promise(async(n,o)=>{this.db||await this.load();const d=this.db.transaction("position","readonly").objectStore("position").get(t);d.onsuccess=g=>{const l=d.result??[];n(l)},d.onerror=g=>{o(g)}})}}var jt=(()=>{var b=import.meta.url;return function(t={}){var n;function o(){return M.buffer!=B.buffer&&F(),B}function c(){return M.buffer!=B.buffer&&F(),Ne}function h(){return M.buffer!=B.buffer&&F(),xe}function d(){return M.buffer!=B.buffer&&F(),Re}function g(){return M.buffer!=B.buffer&&F(),Te}var l=Object.assign({},t),E,D,R=new Promise((e,r)=>{E=e,D=r}),N=typeof window=="object",P=typeof importScripts=="function",S=typeof process=="object"&&typeof process.ma=="object"&&typeof process.ma.node=="string",w=P&&self.name=="em-pthread";l.listen||(l.listen=e=>console.log(e)),l.onError||(l.onError=e=>console.error(e)),l.getRecommendedNnue=(e=0)=>J(pt(e)),l.setNnueBuffer=function(e,r=0){if(!e)throw Error("buf is null");if(0>=e.byteLength)throw Error(`${e.byteLength} bytes?`);const s=ve(e.byteLength);if(!s)throw Error(`could not allocate ${e.byteLength} bytes`);l.HEAPU8.set(e,s),wt(s,e.byteLength,r)},l.uci=function(e){const r=we(e)+1,s=ve(r);if(!s)throw Error(`Could not allocate ${r} bytes`);pe(e,s,r),gt(s)},l.print=e=>l.listen?.(e),l.printErr=e=>l.onError?.(e);var I=Object.assign({},l),$t=[],O="",ae;(N||P)&&(P?O=self.location.href:typeof document<"u"&&document.currentScript&&(O=document.currentScript.src),b&&(O=b),O.startsWith("blob:")?O="":O=O.substr(0,O.replace(/[?#].*/,"").lastIndexOf("/")+1),P&&(ae=e=>{var r=new XMLHttpRequest;return r.open("GET",e,!1),r.responseType="arraybuffer",r.send(null),new Uint8Array(r.response)}));var De=l.print||console.log.bind(console),k=l.printErr||console.error.bind(console);if(Object.assign(l,I),I=null,w){let e=function(...s){console.error(s.join(" "))},r=function(s){try{var i=s.data,f=i.cmd;if(f==="load"){let u=[];self.onmessage=m=>u.push(m),self.startWorker=()=>{postMessage({cmd:"loaded"});for(let m of u)r(m);self.onmessage=r};for(const m of i.handlers)(!l[m]||l[m].proxy)&&(l[m]=(..._)=>{postMessage({ea:"callHandler",pa:m,oa:_})},m=="print"&&(De=l[m]),m=="printErr"&&(k=l[m]));M=i.wasmMemory,F(),Me(i.wasmModule)}else if(f==="run"){ye(i.pthread_ptr,0,0,1,0,0),he(i.pthread_ptr),Xt(),He(),Pe||=!0;try{Zt(i.start_routine,i.arg)}catch(u){if(u!="unwind")throw u}}else f==="cancel"?H()&&re(-1):i.target!=="setimmediate"&&(f==="checkMailbox"?Pe&&ee():f&&(k(`worker: received unknown command ${f}`),k(i)))}catch(u){throw _t(),u}};var Me,Pe=!1;l.printErr||(k=e),self.alert=function(...s){postMessage({ea:"alert",text:s.join(" "),qa:H()})},l.instantiateWasm=(s,i)=>new Promise(f=>{Me=u=>{u=new WebAssembly.Instance(u,$e()),i(u),f()}}),self.onunhandledrejection=s=>{throw s.reason||s},self.onmessage=r}var M,Ae,K=!1,G,B,Ne,xe,Re,Te;function F(){var e=M.buffer;B=new Int8Array(e),l.HEAPU8=Ne=new Uint8Array(e),xe=new Int32Array(e),Re=new Uint32Array(e),Te=new Float64Array(e)}if(!w){if(l.wasmMemory)M=l.wasmMemory;else if(M=new WebAssembly.Memory({initial:1024,maximum:32768,shared:!0}),!(M.buffer instanceof SharedArrayBuffer))throw k("requested a shared WebAssembly.Memory but the returned buffer is not a SharedArrayBuffer, indicating that while the browser has SharedArrayBuffer it does not have WebAssembly threads support - you may need to set a flag"),S&&k("(on node you may need: --experimental-wasm-threads --experimental-wasm-bulk-memory and/or recent version)"),Error("bad memory");F()}var Oe=[],oe=[],Bt=[],Yt=[],Wt=[],ie=!1,z=0,X=null;function je(){if(z--,z==0&&X){var e=X;X=null,e()}}function ce(e){throw e="Aborted("+e+")",k(e),K=!0,G=1,e=new WebAssembly.RuntimeError(e+". Build with -sASSERTIONS for more info."),D(e),e}var qe=e=>e.startsWith("data:application/octet-stream;base64,"),Ce;function Ie(e){if(ae)return ae(e);throw"both async and sync fetching of the wasm failed"}function Ut(e){return(N||P)&&typeof fetch=="function"?fetch(e,{credentials:"same-origin"}).then(r=>{if(!r.ok)throw`failed to load wasm binary file at '${e}'`;return r.arrayBuffer()}).catch(()=>Ie(e)):Promise.resolve().then(()=>Ie(e))}function Fe(e,r,s){return Ut(e).then(i=>WebAssembly.instantiate(i,r)).then(s,i=>{k(`failed to asynchronously prepare wasm: ${i}`),ce(i)})}function Gt(e,r){var s=Ce;return typeof WebAssembly.instantiateStreaming!="function"||qe(s)||typeof fetch!="function"?Fe(s,e,r):fetch(s,{credentials:"same-origin"}).then(i=>WebAssembly.instantiateStreaming(i,e).then(r,function(f){return k(`wasm streaming compile failed: ${f}`),k("falling back to ArrayBuffer instantiation"),Fe(s,e,r)}))}function $e(){return bt={y:Ve,f:tt,t:rt,u:nt,m:Kt,z:Qt,k:Vt,x:Jt,i:er,g:tr,j:he,h:rr,d:nr,l:sr,b:st,w:ar,r:zt,p:ot,q:it,c:Q,e:ct,s:lt,n:ut,v:ht,a:M,o:lr},{a:bt}}function Be(e){this.name="ExitStatus",this.message=`Program terminated with exit(${e})`,this.status=e}var le=e=>{e.terminate(),e.onmessage=()=>{}},Ye=e=>{$.length==0&&(Ze(),Xe($[0]));var r=$.pop();return r?(Y.push(r),j[e.Y]=r,r.Y=e.Y,r.postMessage({cmd:"run",start_routine:e.ga,arg:e.fa,pthread_ptr:e.Y},e.la),0):6},C=0,zt=()=>0<C,x=(e,r,...s)=>{for(var i=s.length,f=Mt(),u=ne(8*i),m=u>>3,_=0;_<s.length;_++){var q=s[_];g()[m+_]=q}return e=St(e,0,i,u,r),ke(f),e};function We(e){if(w)return x(0,1,e);throw G=e,0<C||(ze(),K=!0),new Be(e)}var ue=e=>{if(!(e instanceof Be||e=="unwind"))throw e};function Ue(e){if(w)return x(1,0,e);--C,Q(e)}var Q=e=>{if(G=e,w)throw Ue(e),"unwind";0<C||w||(vt(),L(Yt),kt(0),be[1].length&&ge(1,10),be[2].length&&ge(2,10),ze(),ie=!0),We(e)},$=[],Y=[],Ge=[],j={};function Lt(){for(var e=navigator.hardwareConcurrency;e--;)Ze();Oe.unshift(()=>{z++,Ht(()=>je())})}var ze=()=>{for(var e of Y)le(e);for(e of $)le(e);$=[],Y=[],j=[]},Le=e=>{var r=e.Y;delete j[r],$.push(e),Y.splice(Y.indexOf(e),1),e.Y=0,_e(r)};function He(){Ge.forEach(e=>e())}var Xe=e=>new Promise(r=>{e.onmessage=u=>{u=u.data;var m=u.cmd;if(u.targetThread&&u.targetThread!=H()){var _=j[u.targetThread];_?_.postMessage(u,u.transferList):k(`Internal error! Worker sent a message "${m}" to target pthread ${u.targetThread}, but that thread no longer exists!`)}else m==="checkMailbox"?ee():m==="spawnThread"?Ye(u):m==="cleanupThread"?Le(j[u.thread]):m==="killThread"?(u=u.thread,m=j[u],delete j[u],le(m),_e(u),Y.splice(Y.indexOf(m),1),m.Y=0):m==="cancelThread"?j[u.thread].postMessage({cmd:"cancel"}):m==="loaded"?(e.loaded=!0,r(e)):m==="alert"?alert(`Thread ${u.threadId}: ${u.text}`):u.target==="setimmediate"?e.postMessage(u):m==="callHandler"?l[u.handler](...u.args):m&&k(`worker sent an unknown command ${m}`)},e.onerror=u=>{throw k(`worker sent an error! ${u.filename}:${u.lineno}: ${u.message}`),u};var s=[],i=["print","printErr"],f;for(f of i)l.hasOwnProperty(f)&&s.push(f);e.postMessage({cmd:"load",handlers:s,wasmMemory:M,wasmModule:Ae})});function Ht(e){w?e():Promise.all($.map(Xe)).then(e)}function Ze(){var e=new Worker(new URL(import.meta.url),{type:"module",name:"em-pthread"});$.push(e)}var L=e=>{for(;0<e.length;)e.shift()(l)},Xt=()=>{var e=H(),r=d()[e+52>>2];e=d()[e+56>>2],Dt(r,r-e),ke(r)},V=[],Ke,Zt=(e,r)=>{C=0;var s=V[e];s||(e>=V.length&&(V.length=e+1),V[e]=s=Ke.get(e)),e=s(r),0<C?G=e:re(e)};function Qe(e,r,s,i){return w?x(2,1,e,r,s,i):Ve(e,r,s,i)}var Ve=(e,r,s,i)=>{if(typeof SharedArrayBuffer>"u")return k("Current environment does not support SharedArrayBuffer, pthreads are not available!"),6;var f=[];return w&&f.length===0?Qe(e,r,s,i):(e={ga:s,Y:e,fa:i,la:f},w?(e.ea="spawnThread",postMessage(e,f),0):Ye(e))},Je=typeof TextDecoder<"u"?new TextDecoder("utf8"):void 0,et=(e,r,s)=>{var i=r+s;for(s=r;e[s]&&!(s>=i);)++s;if(16<s-r&&e.buffer&&Je)return Je.decode(e.buffer instanceof SharedArrayBuffer?e.slice(r,s):e.subarray(r,s));for(i="";r<s;){var f=e[r++];if(f&128){var u=e[r++]&63;if((f&224)==192)i+=String.fromCharCode((f&31)<<6|u);else{var m=e[r++]&63;f=(f&240)==224?(f&15)<<12|u<<6|m:(f&7)<<18|u<<12|m<<6|e[r++]&63,65536>f?i+=String.fromCharCode(f):(f-=65536,i+=String.fromCharCode(55296|f>>10,56320|f&1023))}}else i+=String.fromCharCode(f)}return i},J=(e,r)=>e?et(c(),e,r):"";function tt(e,r,s){return w?x(3,1,e,r,s):0}function rt(e,r,s){return w?x(4,1,e,r,s):0}function nt(e,r,s,i){if(w)return x(5,1,e,r,s,i)}var Kt=()=>{ce("")},Qt=()=>1,Vt=e=>{ye(e,!P,1,!N,2097152,!1),He()},he=e=>{typeof Atomics.na=="function"&&(Atomics.na(h(),e>>2,e).value.then(ee),e+=128,Atomics.store(h(),e>>2,1))},ee=()=>{var e=H();if(e&&(he(e),e=Et,!ie&&!K))try{if(e(),!(ie||0<C))try{w?re(G):Q(G)}catch(r){ue(r)}}catch(r){ue(r)}},Jt=(e,r)=>{e==r?setTimeout(ee):w?postMessage({targetThread:e,cmd:"checkMailbox"}):(e=j[e])&&e.postMessage({cmd:"checkMailbox"})},de=[],er=(e,r,s,i,f)=>{for(de.length=i,r=f>>3,s=0;s<i;s++)de[s]=g()[r+s];return(0,ur[e])(...de)},tr=e=>{w?postMessage({cmd:"cleanupThread",thread:e}):Le(j[e])},rr=()=>{},Z=()=>{Z.ca||(Z.ca={}),Z.ca["Blocking on the main thread is very dangerous, see https://emscripten.org/docs/porting/pthreads.html#blocking-on-the-main-browser-thread"]||(Z.ca["Blocking on the main thread is very dangerous, see https://emscripten.org/docs/porting/pthreads.html#blocking-on-the-main-browser-thread"]=1,k("Blocking on the main thread is very dangerous, see https://emscripten.org/docs/porting/pthreads.html#blocking-on-the-main-browser-thread"))},nr=()=>{P||(Z(),ce("Blocking on the main thread is not allowed by default. See https://emscripten.org/docs/porting/pthreads.html#blocking-on-the-main-browser-thread"))},sr=()=>{throw C+=1,"unwind"},st;st=()=>performance.timeOrigin+performance.now();var ar=e=>{var r=c().length;if(e>>>=0,e<=r||2147483648<e)return!1;for(var s=1;4>=s;s*=2){var i=r*(1+.2/s);i=Math.min(i,e+100663296);var f=Math;i=Math.max(e,i);e:{f=(f.min.call(f,2147483648,i+(65536-i%65536)%65536)-M.buffer.byteLength+65535)/65536;try{M.grow(f),F();var u=1;break e}catch{}u=void 0}if(u)return!0}return!1},fe={},at=()=>{if(!me){var e={USER:"web_user",LOGNAME:"web_user",PATH:"/",PWD:"/",HOME:"/home/web_user",LANG:(typeof navigator=="object"&&navigator.languages&&navigator.languages[0]||"C").replace("-","_")+".UTF-8",_:"./this.program"},r;for(r in fe)fe[r]===void 0?delete e[r]:e[r]=fe[r];var s=[];for(r in e)s.push(`${r}=${e[r]}`);me=s}return me},me;function ot(e,r){if(w)return x(6,1,e,r);var s=0;return at().forEach((i,f)=>{var u=r+s;for(f=d()[e+4*f>>2]=u,u=0;u<i.length;++u)o()[f++]=i.charCodeAt(u);o()[f]=0,s+=i.length+1}),0}function it(e,r){if(w)return x(7,1,e,r);var s=at();d()[e>>2]=s.length;var i=0;return s.forEach(f=>i+=f.length+1),d()[r>>2]=i,0}function ct(e){return w?x(8,1,e):52}function lt(e,r,s,i){return w?x(9,1,e,r,s,i):52}function ut(e,r,s,i,f){return w?x(10,1,e,r,s,i,f):70}var be=[null,[],[]],ge=(e,r)=>{var s=be[e];r===0||r===10?((e===1?De:k)(et(s,0)),s.length=0):s.push(r)};function ht(e,r,s,i){if(w)return x(11,1,e,r,s,i);for(var f=0,u=0;u<s;u++){var m=d()[r>>2],_=d()[r+4>>2];r+=8;for(var q=0;q<_;q++)ge(e,c()[m+q]);f+=_}return d()[i>>2]=f,0}var te=e=>e%4===0&&(e%100!==0||e%400===0),dt=[31,29,31,30,31,30,31,31,30,31,30,31],ft=[31,28,31,30,31,30,31,31,30,31,30,31],we=e=>{for(var r=0,s=0;s<e.length;++s){var i=e.charCodeAt(s);127>=i?r++:2047>=i?r+=2:55296<=i&&57343>=i?(r+=4,++s):r+=3}return r},mt=(e,r,s,i)=>{if(!(0<i))return 0;var f=s;i=s+i-1;for(var u=0;u<e.length;++u){var m=e.charCodeAt(u);if(55296<=m&&57343>=m){var _=e.charCodeAt(++u);m=65536+((m&1023)<<10)|_&1023}if(127>=m){if(s>=i)break;r[s++]=m}else{if(2047>=m){if(s+1>=i)break;r[s++]=192|m>>6}else{if(65535>=m){if(s+2>=i)break;r[s++]=224|m>>12}else{if(s+3>=i)break;r[s++]=240|m>>18,r[s++]=128|m>>12&63}r[s++]=128|m>>6&63}r[s++]=128|m&63}}return r[s]=0,s-f};function or(e){var r=Array(we(e)+1);return mt(e,r,0,r.length),r}var ir=(e,r)=>{o().set(e,r)},cr=(e,r,s,i)=>{function f(a,p,v){for(a=typeof a=="number"?a.toString():a||"";a.length<p;)a=v[0]+a;return a}function u(a,p){return f(a,p,"0")}function m(a,p){function v(xt){return 0>xt?-1:0<xt?1:0}var W;return(W=v(a.getFullYear()-p.getFullYear()))===0&&(W=v(a.getMonth()-p.getMonth()))===0&&(W=v(a.getDate()-p.getDate())),W}function _(a){switch(a.getDay()){case 0:return new Date(a.getFullYear()-1,11,29);case 1:return a;case 2:return new Date(a.getFullYear(),0,3);case 3:return new Date(a.getFullYear(),0,2);case 4:return new Date(a.getFullYear(),0,1);case 5:return new Date(a.getFullYear()-1,11,31);case 6:return new Date(a.getFullYear()-1,11,30)}}function q(a){var p=a.Z;for(a=new Date(new Date(a.$+1900,0,1).getTime());0<p;){var v=a.getMonth(),W=(te(a.getFullYear())?dt:ft)[v];if(p>W-a.getDate())p-=W-a.getDate()+1,a.setDate(1),11>v?a.setMonth(v+1):(a.setMonth(0),a.setFullYear(a.getFullYear()+1));else{a.setDate(a.getDate()+p);break}}return v=new Date(a.getFullYear()+1,0,4),p=_(new Date(a.getFullYear(),0,4)),v=_(v),0>=m(p,a)?0>=m(v,a)?a.getFullYear()+1:a.getFullYear():a.getFullYear()-1}var T=d()[i+40>>2];i={ja:h()[i>>2],ia:h()[i+4>>2],aa:h()[i+8>>2],da:h()[i+12>>2],ba:h()[i+16>>2],$:h()[i+20>>2],X:h()[i+24>>2],Z:h()[i+28>>2],ra:h()[i+32>>2],ha:h()[i+36>>2],ka:T?J(T):""},s=J(s),T={"%c":"%a %b %d %H:%M:%S %Y","%D":"%m/%d/%y","%F":"%Y-%m-%d","%h":"%b","%r":"%I:%M:%S %p","%R":"%H:%M","%T":"%H:%M:%S","%x":"%m/%d/%y","%X":"%H:%M:%S","%Ec":"%c","%EC":"%C","%Ex":"%m/%d/%y","%EX":"%H:%M:%S","%Ey":"%y","%EY":"%Y","%Od":"%d","%Oe":"%e","%OH":"%H","%OI":"%I","%Om":"%m","%OM":"%M","%OS":"%S","%Ou":"%u","%OU":"%U","%OV":"%V","%Ow":"%w","%OW":"%W","%Oy":"%y"};for(var A in T)s=s.replace(new RegExp(A,"g"),T[A]);var At="Sunday Monday Tuesday Wednesday Thursday Friday Saturday".split(" "),Nt="January February March April May June July August September October November December".split(" ");T={"%a":a=>At[a.X].substring(0,3),"%A":a=>At[a.X],"%b":a=>Nt[a.ba].substring(0,3),"%B":a=>Nt[a.ba],"%C":a=>u((a.$+1900)/100|0,2),"%d":a=>u(a.da,2),"%e":a=>f(a.da,2," "),"%g":a=>q(a).toString().substring(2),"%G":q,"%H":a=>u(a.aa,2),"%I":a=>(a=a.aa,a==0?a=12:12<a&&(a-=12),u(a,2)),"%j":a=>{for(var p=0,v=0;v<=a.ba-1;p+=(te(a.$+1900)?dt:ft)[v++]);return u(a.da+p,3)},"%m":a=>u(a.ba+1,2),"%M":a=>u(a.ia,2),"%n":()=>`
`,"%p":a=>0<=a.aa&&12>a.aa?"AM":"PM","%S":a=>u(a.ja,2),"%t":()=>"	","%u":a=>a.X||7,"%U":a=>u(Math.floor((a.Z+7-a.X)/7),2),"%V":a=>{var p=Math.floor((a.Z+7-(a.X+6)%7)/7);if(2>=(a.X+371-a.Z-2)%7&&p++,p)p==53&&(v=(a.X+371-a.Z)%7,v==4||v==3&&te(a.$)||(p=1));else{p=52;var v=(a.X+7-a.Z-1)%7;(v==4||v==5&&te(a.$%400-1))&&p++}return u(p,2)},"%w":a=>a.X,"%W":a=>u(Math.floor((a.Z+7-(a.X+6)%7)/7),2),"%y":a=>(a.$+1900).toString().substring(2),"%Y":a=>a.$+1900,"%z":a=>{a=a.ha;var p=0<=a;return a=Math.abs(a)/60,(p?"+":"-")+("0000"+(a/60*100+a%60)).slice(-4)},"%Z":a=>a.ka,"%%":()=>"%"},s=s.replace(/%%/g,"\0\0");for(A in T)s.includes(A)&&(s=s.replace(new RegExp(A,"g"),T[A](i)));return s=s.replace(/\0\0/g,"%"),A=or(s),A.length>r?0:(ir(A,e),A.length-1)},lr=(e,r,s,i)=>cr(e,r,s,i),pe=(e,r,s)=>mt(e,c(),r,s);w||Lt();var ur=[We,Ue,Qe,tt,rt,nt,ot,it,ct,lt,ut,ht],bt,y=function(){function e(s,i){return y=s.exports,Ge.push(y.G),Ke=y.J,oe.unshift(y.A),Ae=i,je(),y}var r=$e();if(z++,l.instantiateWasm)try{return l.instantiateWasm(r,e)}catch(s){k(`Module.instantiateWasm callback failed with error: ${s}`),D(s)}return Ce||=l.locateFile?qe("sf161-70.wasm")?"sf161-70.wasm":l.locateFile?l.locateFile("sf161-70.wasm",O):O+"sf161-70.wasm":new URL("sf161-70.wasm",import.meta.url).href,Gt(r,function(s){e(s.instance,s.module)}).catch(D),{}}();l._main=(e,r)=>(l._main=y.B)(e,r),l.__Z10js_getlinev=e=>(l.__Z10js_getlinev=y.C)(e);var gt=l._uci=e=>(gt=l._uci=y.D)(e),wt=l._setNnueBuffer=(e,r,s)=>(wt=l._setNnueBuffer=y.E)(e,r,s),pt=l._getRecommendedNnue=e=>(pt=l._getRecommendedNnue=y.F)(e),H=()=>(H=y.H)(),yt=l.__emscripten_proxy_main=(e,r)=>(yt=l.__emscripten_proxy_main=y.I)(e,r),vt=()=>(vt=y.K)(),ye=(e,r,s,i,f,u)=>(ye=y.L)(e,r,s,i,f,u),_t=()=>(_t=y.M)(),kt=e=>(kt=y.N)(e),ve=l._malloc=e=>(ve=l._malloc=y.O)(e),St=(e,r,s,i,f)=>(St=y.P)(e,r,s,i,f),_e=e=>(_e=y.Q)(e),re=e=>(re=y.R)(e),Et=()=>(Et=y.S)(),Dt=(e,r)=>(Dt=y.T)(e,r),ke=e=>(ke=y.U)(e),ne=e=>(ne=y.V)(e),Mt=()=>(Mt=y.W)();l.UTF8ToString=J,l.stringToUTF8=pe;var se;X=function e(){se||Pt(),se||(X=e)};function hr(e=[]){var r=yt;C+=1,e.unshift("./this.program");var s=e.length,i=ne(4*(s+1)),f=i;e.forEach(m=>{var _=d(),q=f>>2,T=we(m)+1,A=ne(T);pe(m,A,T),_[q]=A,f+=4}),d()[f>>2]=0;try{var u=r(s,i);Q(u,!0)}catch(m){ue(m)}}function Pt(){0<z||(w?(E(l),w||L(oe),startWorker(l)):(L(Oe),0<z||se||(se=!0,l.calledRun=!0,K||(w||L(oe),w||L(Bt),E(l),hr($t),w||L(Wt)))))}return Pt(),n=R,n}})(),_r=globalThis.self?.name==="em-pthread";_r&&jt();function qt(){return new U().fen()}const kr=(b,t)=>{let n=null;return(...o)=>{window.clearTimeout(n),n=window.setTimeout(()=>{b(...o)},t)}},Fr=(b,t)=>{let n=null;return(...o)=>{window.clearTimeout(n),n=window.setTimeout(async()=>{await b(...o)},t)}},Sr=(b,t)=>{let n=null,o=new Date(0),c=new Date(0);return(...h)=>{const d=new Date-o,g=new Date-c;o=new Date,window.clearInterval(n),Math.max(d,g)>t?(b(...h),c=new Date):n=window.setTimeout(()=>{b(...h),c=new Date},t)}},$r=b=>{const t=new U;return t.load(b),t.turn()==="w"?"white":"black"},Br=(b,t)=>{const n=new U;return n.load(b),n.move(t),n.fen()},Er=(b,t)=>{let n=null,o=new Date(0);return(...c)=>{const h=new Date-o;o=new Date,h>t?b(...c):(window.clearInterval(n),n=window.setTimeout(()=>{b(...c)},t))}};function Yr(b){const t=new Map;return wr.forEach(n=>{const o=b.moves({square:n,verbose:!0});o.length&&t.set(n,o.map(c=>c.to))}),t}function Wr(b,t){const n=new U;n.load(b);const o=Ee(t);return n.move(o),n.history().at(-1)}function Ur(b,t){const n=new U;n.load(b);const o=Ee(t);n.move(o);const c=n.history({verbose:!0}).at(0)?.lan;return{orig:c?.slice(0,2),dest:c?.slice(2,4)}}function Rt(b,t){const n=new U;n.load(b),n.moveNumber();for(let o of t){const c=Ee(o);n.move(c)}return n.history()}function Ee(b){switch(b){case"e8h8":return"e8g8";case"e8a8":return"e8c8";case"e1h1":return"e1g1";case"e1a1":return"e1c1";default:return b}}function Dr(b){const t=b.split(" ");switch(t[0]){case"info":return t.includes("currmove")?null:Mr(t);default:return null}}function Mr(b){let t=1;const n=b.length,o=b[2];for(;b[t]!="multipv"&&t<n;)t+=1;t+=1;const c=b[t];t+=3;const h=b[t];for(;b[t]!="pv"&&t<n;)t+=1;t+=1;const d=b.slice(t);return{multipv:Number(c),cp:Number(h),depth:Number(o),line:d}}const Ct="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1",Pr={fen:"rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1",depth:63,mode:"cloud",cached:!0,lines:[{score:.2,lan:["e2e4","e7e5","g1f3","b8c6","f1b5","g8f6","e1h1","f6e4","f1e1","e4d6"],san:["e4","e5","Nf3","Nc6","Bb5","Nf6","O-O","Nxe4","Re1","Nd6"]},{score:.2,lan:["g1f3","d7d5","d2d4","e7e6","c2c4","g8f6","b1c3","f8b4","c4d5","e6d5"],san:["Nf3","d5","d4","e6","c4","Nf6","Nc3","Bb4","cxd5","exd5"]},{score:.2,lan:["d2d4","g8f6","c2c4","e7e6","g1f3","d7d5","b1c3","f8b4","c4d5","e6d5"],san:["d4","Nf6","c4","e6","Nf3","d5","Nc3","Bb4","cxd5","exd5"]}]};class Ar{tablename;db;status;constructor(t){this.tablename=t,this.status=1}get(t){return new Promise((n,o)=>{this.status!==0&&o("NOT READY");const c=this.db?.transaction(this.tablename,"readonly").objectStore(this.tablename);if(!c){o("UNDEFINED STORE");return}const h=c.get(t);h.onsuccess=d=>{const g=d.target;n(g.result)},h.onerror=()=>{o("DB GET ERROR")}})}ready(){return this.status===0}async size(){return await this.request(t=>t.count())}async getAll(){return await this.request(t=>t.getAll())}async remove(t){return await this.request(n=>n.delete(t))}request(t){return new Promise((n,o)=>{if(!this.ready())return o(`Database <${this.tablename}> is not ready.}`);const c=this.store();if(!c)return o(`Database <${this.tablename}> could not open store.`);const h=t(c);h.onsuccess=()=>{const d=h.result;return d===void 0?o("No result for request."):n(d)},h.onerror=()=>o("Database error.")})}store(){return this.db?.transaction(this.tablename,"readwrite").objectStore(this.tablename)}insert(t,n){return new Promise((o,c)=>{if(this.status!==0){c("NOT READY");return}const h=this.db?.transaction(this.tablename,"readwrite").objectStore(this.tablename);if(!h){c("UNDEFINED STORE");return}const d=h.put(n,t);d.onsuccess=g=>{const l=g.target;if(!l.result){c();return}o(l.result)},d.onerror=()=>{c("DB GET ERROR")}})}load(){return new Promise((t,n)=>{this.status===2&&n(),this.status===0&&t();const o=window.indexedDB.open(this.tablename);o.onerror=c=>{n(c),this.status=2},o.onsuccess=c=>{this.db=c.target.result,this.status=0,t()},o.onupgradeneeded=c=>{this.db=c.target.result,this.db.createObjectStore(this.tablename),this.status=0,t()}})}}class Nr{maxsize;name;db;size;constructor(t,n=1e3){this.name=t,this.maxsize=n,this.db=new Ar(t)}load(){return this.db.load()}async get(t){return(await this.db.get(t))?.value}async count(){return this.size||(this.size=await this.db.size()),this.size}async remove(t){console.log("REMOVING"),await this.db.remove(t)}async add(t,n){if(this.size||(this.size=await this.db.size()),this.size>this.maxsize){const c=await this.db.getAll();c.sort((d,g)=>g.datetime.getTime()-d.datetime.getTime());const h=c.slice(0,100);this.size-=100;for(const d of h)await this.db.remove(d.key)}this.size+=1;const o={key:t,value:n,datetime:new Date};await this.db.insert(t,o)}}function Se(){return{fen:qt(),depth:0,mode:"local",cached:!1,lines:[]}}class xr{subscribers=new Map;engine;last_cloud_request=new Date(0);uci_ready=!1;engine_ready=!0;current_task=null;current_evaluation=Se();other_queue=[];board_queue=[];initialize_wait_queue=[];cache;current_position=qt();sharedWasmMemory=(t,n=32767)=>{let o=4;for(;;)try{return new WebAssembly.Memory({shared:!0,initial:t,maximum:n})}catch(c){if(n<=t||!(c instanceof RangeError))throw c;n=Math.max(t,Math.ceil(n-n/o)),o=o===4?3:4}};async start(){const t=await jt({wasmMemmory:this.sharedWasmMemory(4096),locateFile:o=>`/${o}`}),n=new Set([]);for(let o=0;o<20;o++){const c=t.getRecommendedNnue(o);if(n.has(c))break;n.add(c);const d=await(await fetch(`/${c}`)).arrayBuffer(),g=new Uint8Array(d);try{await t.setNnueBuffer(g,o)}catch(l){console.error(c),console.error(l)}}this.engine=t;try{this.engine?(this.engine.listen=o=>{this.handle_message(o)},this.engine.onError=o=>{console.error(o)},this.engine.uci("uci")):console.error("ENGINE UNDEFINED")}catch(o){console.error(o)}this.cache=new Nr("engine-cache"),await this.cache.load()}wait(){return new Promise((t,n)=>{this.uci_ready?t():this.initialize_wait_queue.push(t)})}async evaluate_next_task(){this.current_evaluation=Se();let t=this.board_queue.pop();this.board_queue=[],t||(t=this.other_queue.pop()),this.current_task=t??null,t&&(this.current_task=t,this.engine_ready=!1,this.current_evaluation.fen=this.current_task.fen,this.evaluate(t))}async handle_message(t){if(t.includes("ponder")||t.includes("bestmove")){this.current_task?.mode==="other"&&this.emit({...this.current_evaluation}),this.current_task&&this.cache?.add(this.current_task.fen,{...this.current_evaluation,cached:!0}),console.log("ENGINE TASK FINISHED"),this.current_task=null,this.engine_ready=!0,this.engine?.uci("isready");return}if(t.includes("readyok")){console.log("ENGINE READY FOR ENXT TASK"),await this.evaluate_next_task();return}if(t.includes("uciok")){this.engine?.uci("setoption name Threads value 16"),this.engine?.uci("setoption name Hash value 1536"),this.engine?.uci("setoption name MultiPV value 3"),this.engine?.uci("ucinewgame");for(const o of this.initialize_wait_queue)o();this.uci_ready=!0,this.engine?.uci("isready");return}const n=Dr(t);if(n){this.current_evaluation.depth=Math.max(this.current_evaluation.depth,n.depth),console.log(this.current_evaluation.depth);const o=Rt(this.current_evaluation.fen,n.line);this.current_evaluation.lines[n.multipv-1]={score:Math.round(n.cp/10)/10,san:o,lan:n.line},this.current_task?.mode==="main"&&this.emit_mainline({...this.current_evaluation})}}emit_mainline=Sr(t=>{const n=this.subscribers.get("main");if(n)for(const o of n)o(t)},300);emit(t){const n=this.subscribers.get(t.fen);if(n)for(const o of n)o(t)}enqueue_other=kr(t=>{this.prepare_task({mode:"other",fen:t,eval_type:"any"})},50);prepare_task(t){if(t.mode==="main"?this.board_queue.push(t):this.other_queue.push(t),!this.uci_ready){console.log(this.uci_ready),console.log("NOT READY");return}if(this.engine_ready){this.engine?.uci("isready");return}this.current_task?.mode==="main"&&(this.engine?.uci("stop"),console.log("STOPPING"))}enqueue_main=Er(t=>{t===Ct?this.emit_mainline(Pr):(console.log("preparing"),this.prepare_task({mode:"main",fen:t,eval_type:"any"}))},1e3);subscribe_main(t){const n=this.subscribers.get("main")??[];n.push(t),this.subscribers.set("main",n)}subscribe_position(t,n){const o=this.subscribers.get(t)??[];o.push(n),this.subscribers.set(t,o)}wait_for(t){return new Promise((n,o)=>{this.subscribe_position(t,c=>{n(c)}),this.enqueue_other(t)})}async evaluate(t){console.log(`FEN: ${t.fen}`);const n=await this.cache?.get(t.fen);if(n){t.mode==="main"?this.emit_mainline(n):this.emit(n),this.current_task=null,this.engine_ready=!0;return}if(t.eval_type==="any"){const o=await this.cloud_evaluation(t);if(o)return this.cache?.add(o.fen,{...o,cached:!0}),t.mode==="main"?this.emit_mainline(o):this.emit(o)}this.start_local_evaluation(t)}start_local_evaluation(t){this.engine?.uci(`position fen ${t.fen}`),this.engine?.uci("go depth 24")}async cloud_evaluation(t){let n=`https://lichess.org/api/cloud-eval?fen=${encodeURIComponent(t.fen)}&multiPv=3`;if(Date.now()-this.last_cloud_request.getTime()<500)return null;const h=await(await fetch(n)).json();if(!h?.pvs)return null;let d=Se();d.depth=h.depth??0,d.fen=h.fen,d.mode="cloud";for(const g of h.pvs.slice(0,3)){let l=g.moves.split(" ");d.lines.push({score:Math.round(g.cp/10)/10,lan:l,san:Rt(d.fen,l)})}return this.current_task=null,this.engine_ready=!0,d}}class Tt{data;listeners=[];constructor(t){this.data=t}set(t){this.data={...this.data,...t},console.log("n listeners: "+this.listeners.length);for(const n of this.listeners)n(this.data)}on(t){this.listeners.push(t),t(this.data)}}class Rr{board=new Tt({active:!1,fen:Ct});sidebar=new Tt({active:!1,view:"user",data:void 0})}class Tr{color;mode;listeners;systemTheme;constructor(t="light"){this.color=t,this.listeners=[],this.systemTheme="light",fr(()=>{this.loadSaved(),this.emit()})}emit(){let t=this.color==="system"?this.systemTheme:this.color;for(const n of this.listeners)n(this.mode,t)}onChange(t){this.listeners.push(t),this.emit()}loadSaved(){if(window){const t=window.localStorage.getItem("saknoto-color"),n=window.localStorage.getItem("saknoto-mode");t?this.color=t:this.set_color("neutral-266"),n?this.mode=n:this.set_mode("light")}}set_color(t){this.color=t,window.localStorage.setItem("saknoto-color",this.color),this.emit()}set_mode(t){this.mode=t,window.localStorage.setItem("saknoto-mode",this.mode),this.emit()}get_color(){return this.color}get_mode(){return this.mode}}const It={userManager:new Ot,openingGraph:new yr,repertoire:new vr,engine:new xr,ui:new Rr,themeManager:new Tr},Ft=mr(It),Gr=()=>br(Ft),zr=b=>dr(Ft.Provider,{value:It,get children(){return b.children}});export{Nr as L,Ct as S,zr as a,Br as b,Pr as c,Fr as d,Ur as e,$r as g,Ee as m,Wr as p,qt as s,Yr as t,Gr as u};
